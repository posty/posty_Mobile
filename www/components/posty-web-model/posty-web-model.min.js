/*!vim: et:ts=4:sw=4:sts=4 
* posty_webModel

* Copyright 2014 posty-soft.org
* Licensed under the LGPL v3
* https://www.gnu.org/licenses/lgpl.html
*/

"use strict";var app=angular.module("postySoft.models",[]),errorMsg=function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b=b+". "+a[c]);return b.substr(2,b.length)+"."};app.factory("AlertService",["$timeout",function(a){var b=[],c=1e4,d=function(){b.splice(0,1)};return{addAlert:function(e,f){b.push({type:e,msg:f});a(d,c)},closeAlert:function(a){b.splice(a,1)},clearAlerts:function(){b=[]},alerts:function(){return b}}}]),app.factory("Servers",["Restangular",function(a){var b=[],c={url:"",key:""},d=c;return{add:function(a){b.push(a)},remove:function(a){var c=b.indexOf(a);c>-1&&b.splice(c,1)},currentServer:function(){return d},setCurrentServer:function(b){b!=d&&(d=b,a.setBaseUrl(b.url),a.setDefaultHeaders({"Content-Type":"application/json",auth_token:b.key}))},getList:function(){return b},moreThanOneServer:function(){return b.length>1},isValid:function(){return null!=d}}}]),app.factory("Domains",["$q","Restangular","AlertService",function(a,b,c){var d={name:"all Domains"},e=d,f=[],g=[],h=[],i=function(){for(var a=0;a<h.length;a++)h[a].update()},j=function(a){for(var b=0;b<h.length;b++)if(h[b].getName()===a.getName())return!0;return!1},k=function(){var c=a.defer();f=[],g=[];var d=b.all("domains");return d.getList().then(function(a){for(var b=0;b<a.length;b++)g.push(angular.copy(a[b])),f.push(a[b].virtual_domain);c.resolve(f)},function(a){c.reject({msg:"Error refrehsing the domains!",response:a})}),c.promise},l=function(a){for(var b=0;b<g.length;b++)if(g[b].virtual_domain.id==a)return g[b].virtual_domain};return{ALL_DOMAINS:d,isValid:function(a){return a&&a!=d},allDomainsSelected:function(){return e==d},currentDomain:function(){return e},setCurrentDomain:function(a){a!=e&&(e=a,i())},create:function(f){var g=a.defer(),h=b.all("domains");return h.post(f).then(function(){var a="New domain created: "+f.name;c.addAlert("success",a),e=d,k().then(function(){g.resolve(f)},function(a){g.reject(a)})},function(a){var b="There was an error saving the domain "+f.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),g.reject({msg:b,response:a})}),g.promise},edit:function(d){var e=a.defer(),f=l(d.id),g=b.one("domains",f.name);return g.name=d.name,g.put().then(function(){var a="Domain "+d.name+" updated!";c.addAlert("success",a),k().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error updating the domain "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(f){var g=a.defer(),h=b.one("domains",f.name);return h.remove().then(function(){var a="Domain "+f.name+" deleted!";c.addAlert("success",a),f==e&&(e=d),k().then(function(){g.resolve(f)},function(a){g.reject(a)})},function(a){var b="There was an error deleting the domain "+f.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),g.reject({msg:b,response:a})}),g.promise},getList:function(){return f},getByID:function(a){for(var b=0;b<f.length;b++)if(f[b].id==a)return f[b]},refresh:function(){return k()},registerCurrentDomainObserver:function(a){j(a)||h.push(a)},unregisterCurrentDomainObserver:function(a){var b=h.indexOf(a);b>-1&&h.splice(b,1)}}}]),app.factory("DomainAliasses",["$q","Restangular","AlertService","Domains",function(a,b,c,d){var e=[],f=null,g=function(){var c=a.defer();return e=[],d.isValid(f)&&b.one("domains",f.name).all("aliases").getList().then(function(a){for(var b=0;b<a.length;b++)e.push(a[b].virtual_domain_alias);c.resolve(e)},function(a){c.reject({msg:"Error refrehsing the domain aliasses!",response:a})}),c.promise};return{setDomain:function(a){f!=a&&(f=a)},getDomain:function(){return f},create:function(d){var e=a.defer(),h=b.one("domains",f.name).all("aliases");return h.post(d).then(function(){var a="New domain alias created: "+d.name;c.addAlert("success",a),g().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error saving the domain alias "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(d){var e=a.defer(),h=b.one("domains",f.name).one("aliases",d.name);return h.remove().then(function(){var a="Domain alias "+d.name+" deleted!";c.addAlert("success",a),g().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error deleting the domain alias "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},getList:function(){return e},refresh:function(){return g()}}}]),app.factory("Transports",["$q","Restangular","AlertService",function(a,b,c){var d=[],e=[],f=function(){var c=a.defer();d=[],e=[];var f=b.all("transports");return f.getList().then(function(a){for(var b=0;b<a.length;b++)e.push(angular.copy(a[b])),d.push(a[b].virtual_transport);c.resolve(d)},function(a){c.reject({msg:"Error refrehsing the transports!",response:a})}),c.promise},g=function(a){for(var b=0;b<e.length;b++)if(e[b].virtual_transport.id==a)return e[b].virtual_transport};return{create:function(d){var e=a.defer(),g=b.all("transports");return g.post(d).then(function(){var a="New transport created: "+d.name;c.addAlert("success",a),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error saving the transport "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},edit:function(d){var e=a.defer(),h=g(d.id),i=b.one("transports",h.name);return i.name=d.name,i.destination=d.destination,i.put().then(function(){var a="Transport "+d.name+" updated!";c.addAlert("success",a),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error updating the transport "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(d){var e=a.defer(),g=b.one("transports",d.name);return g.remove().then(function(){var a="Transport "+d.name+" deleted!";c.addAlert("success",a),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error deleting the transport "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},getList:function(){return d},refresh:function(){return f()}}}]),app.factory("Users",["$q","Restangular","AlertService","Domains",function(a,b,c,d){var e=[],f=[],g=null,h=function(){var c=a.defer();return e=[],f=[],d.isValid(g)&&b.one("domains",g.name).all("users").getList().then(function(a){for(var b=0;b<a.length;b++)f.push(angular.copy(a[b])),e.push(a[b].virtual_user);c.resolve(e)},function(a){c.reject({msg:"Error refreshing the users!",response:a})}),c.promise},i=function(a){for(var b=0;b<f.length;b++)if(f[b].virtual_user.id==a)return f[b].virtual_user};return{isValid:function(a){return null!=a},setDomain:function(a){g!=a&&(g=a)},getDomain:function(){return g},create:function(d){var e=a.defer(),f=b.one("domains",g.name).all("users");return f.post(d).then(function(){var a="New user created: "+d.name;c.addAlert("success",a),h().then(function(){e.resolve(g)},function(a){e.reject(a)})},function(a){var b="There was an error saving the user "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},edit:function(d){var e=a.defer(),f=i(d.id),j=b.one("domains",g.name).one("users",f.name);return j.name=d.name,j.quota=d.quota,d.password!=j.password&&(j.password=d.password),j.put().then(function(){var a="User "+d.name+" updated!";c.addAlert("success",a),h().then(function(){e.resolve(g)},function(a){e.reject(a)})},function(a){var b="There was an error updating the user "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(d){var e=a.defer(),f=b.one("domains",g.name).one("users",d.name);return f.remove().then(function(){var a="User "+d.name+" deleted!";c.addAlert("success",a),h().then(function(){e.resolve(g)},function(a){e.reject(a)})},function(a){var b="There was an error deleting the user "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},getList:function(){return e},refresh:function(){return h()}}}]),app.factory("UserAliasses",["$q","Restangular","AlertService","Domains","Users",function(a,b,c,d,e){var f=[],g=null,h=null,i=function(){var c=a.defer();return f=[],d.isValid(g)&&e.isValid(h)&&b.one("domains",g.name).one("users",h.name).all("aliases").getList().then(function(a){for(var b=0;b<a.length;b++)f.push(a[b].virtual_user_alias);c.resolve(f)},function(a){c.reject({msg:"Error refrehsing the user aliasses!",response:a})}),c.promise};return{setDomain:function(a){g!=a&&(g=a)},getDomain:function(){return g},setUser:function(a){h!=a&&(h=a)},getUser:function(){return h},create:function(d){var e=a.defer(),f=b.one("domains",g.name).one("users",h.name).all("aliases");return f.post(d).then(function(){var a="New user alias created: "+d.name;c.addAlert("success",a),i().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error saving the user alias "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(d){var e=a.defer(),f=b.one("domains",g.name).one("users",h.name).one("aliases",d.name);return f.remove().then(function(){var a="User alias "+d.name+" deleted!";c.addAlert("success",a),i().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error deleting the user alias "+d.name+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},getList:function(){return f},refresh:function(){return i()}}}]),app.factory("Summaries",["$q","Restangular",function(a,b){var c=[],d=function(){var d=a.defer();return c=[],b.all("summary").getList().then(function(a){angular.forEach(a,function(a){var b=new Object;b.value=a.count,b.percent=a.count,b.name=a.name,b.caption=a.name+": "+a.count.toFixed(0),c.push(b)}),d.resolve(c)},function(a){d.reject({msg:"Error refrehsing the summary!",response:a})}),d.promise};return{getList:function(){return c},refresh:function(){return d()}}}]),app.factory("ApiKeys",["$q","Restangular","AlertService",function(a,b,c){var d=[],e=[],f=function(){var c=a.defer();return d=[],e=[],b.all("api_keys").getList().then(function(a){for(var b=0;b<a.length;b++)e.push(angular.copy(a[b])),d.push(a[b].api_key);c.resolve(d)},function(a){c.reject({msg:"Error refrehsing the api-keys!",response:a})}),c.promise};return{create:function(d){var e=a.defer(),g=b.all("api_keys");return g.post(d).then(function(a){var b="New api-key created: "+a.api_key.access_token;c.addAlert("success",b),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error saving the api-key "+a.api_key.access_token+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},edit:function(d){var e=a.defer(),g=b.one("api_keys",d.access_token);return g.expires_at=d.expires_at,g.active=Number(d.active),g.put().then(function(){var a="Api-key "+d.access_token+" updated!";c.addAlert("success",a),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error updating the api-key "+d.access_token+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},remove:function(d){var e=a.defer(),g=b.one("api_keys",d.access_token);return g.remove().then(function(){var a="Api-key "+d.access_token+" deleted!";c.addAlert("success",a),f().then(function(){e.resolve(d)},function(a){e.reject(a)})},function(a){var b="There was an error deleting the api-key "+d.access_token+": \n"+errorMsg(a.data.error);c.addAlert("danger",b),e.reject({msg:b,response:a})}),e.promise},getList:function(){return d},refresh:function(){return f()},isExpired:function(a){var b=new Date,c=new Date(a.expires_at);return 0>c-b}}}]);
//# sourceMappingURL=posty-web-model.min.map